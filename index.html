<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <title>ALPINE AWARENESS MAP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script src="data/OEBB_NETWORK_EDGES_2.js"></script>
    <script src="data/strecken_polyline_3.js"></script>

    <style>
        html, body, #map { 
            width: 100%; 
            height: 100%; 
            padding: 0; 
            margin: 0; 
            background: #ffffff; 
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        // 1. Karte auf Tirol zentrieren
        var map = L.map('map').setView([47.26, 11.39], 8);

        // 2. Hintergrund-Karte (Stabile Version für Firefox & Mobile)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // 3. Gelbe Bahnlinien Österreich
        if (typeof json_OEBB_NETWORK_EDGES_2 !== 'undefined') {
            L.geoJson(json_OEBB_NETWORK_EDGES_2, {
                style: { color: '#f0ff2d', weight: 2, opacity: 1 }
            }).addTo(map);
        }

        // 4. Gelbe Bahnlinien Deutschland
        if (typeof json_strecken_polyline_3 !== 'undefined') {
            L.geoJson(json_strecken_polyline_3, {
                style: { color: '#f0ff2d', weight: 2, opacity: 1 }
            }).addTo(map);
        }

        // 5. Camps aus Google Sheets laden
        const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRgubvpjQe4h8QkLTlO3KojadPfkRtW7LbmIVEOwPso4Pvp6dF_fCSF0XRHnTQso9FcC_0xHtWg-Vx3/pub?output=csv';

        fetch(googleSheetUrl)
            .then(res => res.text())
            .then(csvText => {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        results.data.forEach(function(row) {
                            // Koordinaten auslesen und in Zahlen umwandeln
                            let lat = parseFloat(row.lat || row.Lat);
                            let lon = parseFloat(row.lon || row.Lon);
                            let name = row.name || "Camp";
                            let type = (row.typ || "default").trim().toLowerCase();

                            if (!isNaN(lat) && !isNaN(lon)) {
                                // Pfad zum Marker-Icon
                                let iconPath = 'markers/' + type + '.svg';

                                const customIcon = L.icon({
                                    iconUrl: iconPath,
                                    iconSize: [32, 32],
                                    iconAnchor: [16, 32],
                                    popupAnchor: [0, -32],
                                    className: 'map-marker'
                                });

                                L.marker([lat, lon], {icon: customIcon})
                                    .addTo(map)
                                    .bindPopup("<b>" + name + "</b><br>Typ: " + type.toUpperCase());
                            }
                        });
                    }
                });
            })
            .catch(err => console.error("Fehler beim Laden von Google Sheets:", err));

    </script>
</body>
</html>
