<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <title>ALPINE AWARENESS MAP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script src="data/OEBB_NETWORK_EDGES_2.js"></script>
    <script src="data/strecken_polyline_3.js"></script>

    <style>
        html, body, #map { 
            width: 100%; 
            height: 100%; 
            padding: 0; 
            margin: 0; 
            background: #f0f0f0; 
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        var map = L.map('map').setView([47.26, 11.39], 8);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap © CartoDB',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        if (typeof json_OEBB_NETWORK_EDGES_2 !== 'undefined') {
            L.geoJson(json_OEBB_NETWORK_EDGES_2, {
                style: { color: '#f0ff2d', weight: 2, opacity: 1 }
            }).addTo(map);
        }

        if (typeof json_strecken_polyline_3 !== 'undefined') {
            L.geoJson(json_strecken_polyline_3, {
                style: { color: '#f0ff2d', weight: 2, opacity: 1 }
            }).addTo(map);
        }

        const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRgubvpjQe4h8QkLTlO3KojadPfkRtW7LbmIVEOwPso4Pvp6dF_fCSF0XRHnTQso9FcC_0xHtWg-Vx3/pub?output=csv';

        fetch(googleSheetUrl)
            .then(res => res.text())
            .then(csvText => {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        results.data.forEach(function(row) {
                            let lat = parseFloat(row.lat || row.Lat);
                            let lon = parseFloat(row.lon || row.Lon);
                            let name = row.name || "Camp";
                            let typeRaw = (row.typ || "default").trim();
                            let type = typeRaw.toLowerCase();
                            let date = row.datum || row.Datum || "tba";
                            let info = row['Info für dich'] || ""; // Liest deine Info-Spalte aus

                            if (!isNaN(lat) && !isNaN(lon)) {
                                // Ersetzt Leerzeichen im Dateinamen 
                                let iconFileName = type.replace(/\s+/g, '') + '.svg';
                                let iconPath = 'markers/' + iconFileName;

                                const customIcon = L.icon({
                                    iconUrl: iconPath,
                                    iconSize: [32, 32],
                                    iconAnchor: [16, 32],
                                    popupAnchor: [0, -32]
                                });

                                let popupContent = `
                                    <div style="font-family: sans-serif;">
                                        <b style="font-size: 14px;">${name}</b><br>
                                        <span style="color: #666;">${date}</span><br>
                                        <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0;">
                                        <b>Kategorie:</b> ${typeRaw}<br>
                                        ${info ? `<i>${info}</i>` : ""}
                                    </div>
                                `;

                                L.marker([lat, lon], {icon: customIcon})
                                    .addTo(map)
                                    .bindPopup(popupContent);
                            }
                        });
                    }
                });
            });
    </script>
</body>
</html>
